<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<div th:fragment="script-descuentos">
    <script th:inline="javascript">
        /*<![CDATA[*/
        // ========== CONFIGURACIÓN DE DESCUENTOS ==========
        const descuentosFijos = [
            { id: 1, motivo: "🎉 Cliente frecuente", tipo: "porcentaje", valor: 10, activo: true },
            { id: 2, motivo: "🔥 Promoción especial", tipo: "monto_fijo", valor: 10, activo: true },
            { id: 3, motivo: "📦 Daño de empaque", tipo: "porcentaje", valor: 5, activo: true },
            { id: 4, motivo: "👋 Primera compra", tipo: "porcentaje", valor: 15, activo: true },
            { id: 5, motivo: "📚 Compra al por mayor", tipo: "monto_fijo", valor: 25, activo: true }
        ];

        let descuentoAplicado = null;

        // Función para cargar descuentos fijos en el modal
        function cargarDescuentosFijos() {
            const container = document.getElementById('listaDescuentosFijos');
            if (!container) return;

            container.innerHTML = '';

            descuentosFijos.filter(d => d.activo).forEach(descuento => {
                const descuentoElement = document.createElement('div');
                descuentoElement.className = 'col-md-6';
                descuentoElement.innerHTML = `
                    <div class="card h-100 descuento-card" data-id="${descuento.id}">
                        <div class="card-body">
                            <h6 class="card-title">${descuento.motivo}</h6>
                            <p class="card-text">
                                ${descuento.tipo === 'porcentaje'
                                    ? `${descuento.valor}% de descuento`
                                    : `$${descuento.valor.toFixed(2)} de descuento`}
                            </p>
                            <small class="text-muted">Haga clic para seleccionar</small>
                        </div>
                    </div>
                `;
                container.appendChild(descuentoElement);
            });

            // Agregar event listeners a las tarjetas de descuento
            document.querySelectorAll('.descuento-card').forEach(card => {
                card.addEventListener('click', function() {
                    // Remover selección anterior
                    document.querySelectorAll('.descuento-card').forEach(c => {
                        c.classList.remove('border-primary', 'bg-light');
                    });

                    // Seleccionar actual
                    this.classList.add('border-primary', 'bg-light');

                    const descuentoId = parseInt(this.getAttribute('data-id'));
                    descuentoAplicado = descuentosFijos.find(d => d.id === descuentoId);
                });
            });
        }

        // Función para calcular descuento
        function calcularMontoDescuento(subtotal, descuento) {
            if (descuento.tipo === 'porcentaje') {
                return subtotal * (descuento.valor / 100);
            } else {
                return descuento.valor;
            }
        }

        // Función para recalcular totales después de aplicar descuento
        function recalcularTotalesConDescuento() {
            const subtotalInput = document.getElementById('subtotalInput');
            const descuentoInput = document.getElementById('descuentoInput');
            const impuestosInput = document.getElementById('impuestosInput');
            const totalInput = document.getElementById('totalInput');

            if (!subtotalInput || !descuentoInput || !impuestosInput || !totalInput) return;

            const subtotal = parseFloat(subtotalInput.value) || 0;
            const descuento = parseFloat(descuentoInput.value) || 0;
            const baseImponible = Math.max(0, subtotal - descuento);
            const impuestos = baseImponible * 0.13;
            const total = baseImponible + impuestos;

            impuestosInput.value = impuestos.toFixed(2);
            totalInput.value = total.toFixed(2);
        }

        // Función para aplicar descuento
        function aplicarDescuento() {
            const subtotalInput = document.getElementById('subtotalInput');
            const descuentoInput = document.getElementById('descuentoInput');
            const motivoText = document.getElementById('motivoDescuentoText');

            if (!subtotalInput || !descuentoInput) return;

            const subtotal = parseFloat(subtotalInput.value) || 0;

            if (!descuentoAplicado) {
                alert('Por favor seleccione un descuento primero');
                return;
            }

            const montoDescuento = calcularMontoDescuento(subtotal, descuentoAplicado);

            // Validar que el descuento no sea mayor al subtotal
            if (montoDescuento > subtotal) {
                alert('El descuento no puede ser mayor al subtotal');
                return;
            }

            // Validar límite máximo del 50% para descuentos porcentuales
            if (descuentoAplicado.tipo === 'porcentaje' && descuentoAplicado.valor > 50) {
                if (!confirm(`⚠️ ¿Está seguro de aplicar un descuento del ${descuentoAplicado.valor}%? Este supera el límite normal del 50%.`)) {
                    return;
                }
            }

            // Aplicar descuento a los campos
            descuentoInput.value = montoDescuento.toFixed(2);

            // Mostrar motivo del descuento
            if (motivoText) {
                motivoText.textContent = `Motivo: ${descuentoAplicado.motivo}`;
                motivoText.className = 'text-success fw-semibold';
            }

            // Actualizar totales inmediatamente
            recalcularTotalesConDescuento();

            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDescuentos'));
            modal.hide();
        }

        // Función para quitar descuento
        function quitarDescuento() {
            const descuentoInput = document.getElementById('descuentoInput');
            const motivoText = document.getElementById('motivoDescuentoText');

            if (!descuentoInput) return;

            descuentoAplicado = null;
            descuentoInput.value = '0.00';

            if (motivoText) {
                motivoText.textContent = '';
                motivoText.className = 'text-muted';
            }

            // Actualizar totales inmediatamente
            recalcularTotalesConDescuento();

            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDescuentos'));
            modal.hide();
        }

        // Inicializar eventos de descuentos
        function inicializarDescuentos() {
            const btnAbrirModal = document.getElementById('btnAbrirModalDescuentos');
            const btnAplicarDescuento = document.getElementById('btnAplicarDescuento');
            const btnQuitarDescuento = document.getElementById('btnQuitarDescuento');
            const valorPersonalizado = document.getElementById('valorDescuentoPersonalizado');

            if (btnAbrirModal) {
                btnAbrirModal.addEventListener('click', function() {
                    const modal = new bootstrap.Modal(document.getElementById('modalDescuentos'));
                    modal.show();
                });
            }

            if (btnAplicarDescuento) {
                btnAplicarDescuento.addEventListener('click', aplicarDescuento);
            }

            if (btnQuitarDescuento) {
                btnQuitarDescuento.addEventListener('click', quitarDescuento);
            }

            if (valorPersonalizado) {
                valorPersonalizado.addEventListener('input', function() {
                    if (this.value) {
                        const tipo = document.getElementById('tipoDescuentoPersonalizado').value;
                        const motivo = document.getElementById('motivoDescuentoPersonalizado').value || 'Descuento personalizado';

                        descuentoAplicado = {
                            motivo: motivo,
                            tipo: tipo,
                            valor: parseFloat(this.value)
                        };
                    }
                });
            }

            // Resetear selección de descuentos al cambiar de pestaña
            document.querySelectorAll('#descuentoTabs .nav-link').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Limpiar selección de descuentos fijos
                    document.querySelectorAll('.descuento-card').forEach(c => {
                        c.classList.remove('border-primary', 'bg-light');
                    });
                    descuentoAplicado = null;

                    // Limpiar campos de descuento personalizado
                    if (this.id === 'personalizado-tab') {
                        document.getElementById('valorDescuentoPersonalizado').value = '';
                        document.getElementById('motivoDescuentoPersonalizado').value = '';
                    }
                });
            });

            cargarDescuentosFijos();
        }

        // Ejecutar cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarDescuentos);
        } else {
            inicializarDescuentos();
        }
        /*]]>*/
    </script>
</div>
</html>