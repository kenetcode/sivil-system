<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout ('Ventas - Sistema SIVIL', ~{::content})}">
<head>
    <title>Ventas - Sistema SIVIL</title>
</head>
<body>
<div th:fragment="content">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="bi bi-receipt"></i> Gestión de Ventas</h2>
                <p class="text-muted">Listado completo de todas las ventas del sistema</p>
            </div>
            <a th:href="@{/ventas/crear}" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Nueva Venta
            </a>
        </div>
    </div>

    <!-- Mensaje de éxito -->
    <div th:if="${ok}" class="alert alert-success" th:text="${ok}"></div>

    <!-- Mensaje de error -->
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <!-- Formulario de búsqueda y filtrado -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-search"></i> Búsqueda y Filtrado de Ventas</h5>
        </div>
        <div class="card-body">
            <form method="get" th:action="@{/ventas/listar}" class="row g-3">
                <div class="col-md-5">
                    <label for="numeroFactura" class="form-label">N° Factura</label>
                    <input type="text" class="form-control" id="numeroFactura" name="numeroFactura" 
                           th:value="${numeroFactura}" placeholder="Ej: FAC-001">
                    <small class="form-text text-muted">Busca por número de factura completo o parcial</small>
                </div>
                <div class="col-md-5">
                    <label for="nombreCliente" class="form-label">Nombre Cliente</label>
                    <input type="text" class="form-control" id="nombreCliente" name="nombreCliente" 
                           th:value="${nombreCliente}" placeholder="Nombre del cliente">
                    <small class="form-text text-muted">Busca por nombre del cliente completo o parcial</small>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <div class="d-grid gap-2 w-100">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                        <a th:href="@{/ventas/listar}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Limpiar
                        </a>
                    </div>
                </div>
                <div class="col-12" th:if="${searchActive}">
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-funnel-fill"></i> Mostrando resultados filtrados
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tarjetas de estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Ventas</h5>
                    <p class="card-text display-6" th:text="${totalVentas}">0</p>
                </div>
            </div>
        </div>
        <!-- Se eliminaron las tarjetas de Ventas Activas, Ventas Hoy y Promedio por Venta -->
        <!-- Para mantener el espacio visual, podrías dejar los otros 3 col-md-3 vacíos si lo deseas -->
        <div class="col-md-9"></div>
    </div>

    <!-- Tabla de ventas -->
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
            <tr>
                <th>N° Factura</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Vendedor</th>
                <th class="text-end">Subtotal</th>
                <th class="text-end">Impuestos</th>
                <th class="text-end">Total</th>
                <th>Método Pago</th>
                <th>Estado</th>
                <th class="text-center">Acciones</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="venta : ${ventas}">
                <td th:text="${venta.numero_factura}">FAC-001</td>
                <td th:text="${venta.fecha_venta != null} ? ${#temporals.format(venta.fecha_venta, 'dd/MM/yyyy HH:mm')} : '-'">01/01/2023</td>
                <td th:text="${venta.nombre_cliente}">Cliente Ejemplo</td>
                <td th:text="${venta.vendedor != null ? venta.vendedor.nombre_completo : 'N/A'}">Vendedor</td>
                <td class="text-end" th:text="${'$' + #numbers.formatDecimal(venta.subtotal, 1, 'COMMA', 2, 'POINT')}">$0.00</td>
                <td class="text-end" th:text="${'$' + #numbers.formatDecimal(venta.impuestos, 1, 'COMMA', 2, 'POINT')}">$0.00</td>
                <td class="text-end fw-bold" th:text="${'$' + #numbers.formatDecimal(venta.total, 1, 'COMMA', 2, 'POINT')}">$0.00</td>
                <td>
                    <span class="badge bg-info" th:if="${venta.tipo_pago.name() == 'efectivo'}">Efectivo</span>
                    <span class="badge bg-primary" th:if="${venta.tipo_pago.name() == 'tarjeta'}">Tarjeta</span>
                </td>
                <td>
                    <span class="badge bg-success" th:if="${venta.estado.name() == 'activa'}">Activa</span>
                    <span class="badge bg-secondary" th:if="${venta.estado.name() == 'inactiva'}">Inactiva</span>
                    <span class="badge bg-primary" th:if="${venta.estado.name() == 'finalizada'}">Finalizada</span>
                </td>
                <td class="text-center">
                    <!-- Botón Ver Detalle -->
                    <button type="button" class="btn btn-sm btn-outline-info" 
                            data-bs-toggle="modal" 
                            th:data-bs-target="'#modalDetalle' + ${venta.id_venta}"
                            title="Ver detalle completo">
                        <i class="bi bi-eye"></i> Ver Detalle
                    </button>
                    
                    <!-- Botón Modificar (solo para ventas no inactivas) -->
                    <a th:if="${venta.estado.name() != 'inactiva'}"
                       th:href="@{|/ventas/${venta.id_venta}/modificar|}" 
                       class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-pencil"></i> Modificar
                    </a>

                    <!-- Botón Inactivar (solo para ventas activas y finalizadas) -->
                    <a th:if="${venta.estado.name() != 'inactiva'}"
                       th:href="@{|/ventas/inactivar/${venta.numero_factura}|}"
                       class="btn btn-sm btn-outline-danger" title="Inactivar venta">
                        <i class="bi bi-slash-circle"></i> Inactivar
                    </a>
                    
                    <!-- Botón Reactivar (solo para ventas inactivas) -->
                    <a th:if="${venta.estado.name() == 'inactiva'}"
                       th:href="@{|/ventas/reactivar/${venta.numero_factura}|}"
                       class="btn btn-sm btn-outline-success" title="Reactivar venta">
                        <i class="bi bi-arrow-clockwise"></i> Reactivar
                    </a>
                    
                    <!-- Mostrar motivo de inactivación si está inactiva -->
                    <button th:if="${venta.estado.name() == 'inactiva' && venta.motivo_inactivacion != null}"
                            type="button" class="btn btn-sm btn-outline-secondary" 
                            th:attr="data-motivo=${venta.motivo_inactivacion}"
                            onclick="alert('Motivo de inactivación:\n\n' + this.getAttribute('data-motivo'))"
                            title="Ver motivo de inactivación">
                        <i class="bi bi-info-circle"></i> Motivo
                    </button>

                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(ventas)}">
                <td colspan="10" class="text-center text-muted">No hay ventas registradas</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Modales de detalle de venta -->
    <div th:each="venta : ${ventas}">
        <div class="modal fade" th:id="'modalDetalle' + ${venta.id_venta}" tabindex="-1" 
             th:aria-labelledby="'modalDetalleLabel' + ${venta.id_venta}" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" th:id="'modalDetalleLabel' + ${venta.id_venta}">
                            <i class="bi bi-receipt"></i> Detalle de Venta - <span th:text="${venta.numero_factura}"></span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Información General -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Información General</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>N° Factura:</strong> <span th:text="${venta.numero_factura}"></span></p>
                                        <p><strong>Fecha:</strong> 
                                            <span th:text="${venta.fecha_venta != null} ? ${#temporals.format(venta.fecha_venta, 'dd/MM/yyyy HH:mm')} : '-'"></span>
                                        </p>
                                        <p><strong>Estado:</strong>
                                            <span class="badge bg-success" th:if="${venta.estado.name() == 'activa'}">Activa</span>
                                            <span class="badge bg-secondary" th:if="${venta.estado.name() == 'inactiva'}">Inactiva</span>
                                            <span class="badge bg-primary" th:if="${venta.estado.name() == 'finalizada'}">Finalizada</span>
                                        </p>
                                        <p><strong>Método de Pago:</strong>
                                            <span class="badge bg-info" th:if="${venta.tipo_pago.name() == 'efectivo'}">Efectivo</span>
                                            <span class="badge bg-primary" th:if="${venta.tipo_pago.name() == 'tarjeta'}">Tarjeta</span>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Cliente:</strong> <span th:text="${venta.nombre_cliente}"></span></p>
                                        <p th:if="${venta.identificacion_cliente != null && !venta.identificacion_cliente.isEmpty()}">
                                            <strong>Identificación:</strong> <span th:text="${venta.identificacion_cliente}"></span>
                                        </p>
                                        <p th:if="${venta.contacto_cliente != null && !venta.contacto_cliente.isEmpty()}">
                                            <strong>Contacto:</strong> <span th:text="${venta.contacto_cliente}"></span>
                                        </p>
                                        <p><strong>Vendedor:</strong> <span th:text="${venta.vendedor?.nombre_completo}"></span></p>
                                    </div>
                                </div>
                                <div th:if="${venta.estado.name() == 'inactiva' && venta.motivo_inactivacion != null}" 
                                     class="alert alert-warning mt-2">
                                    <strong>Motivo de Inactivación:</strong> <span th:text="${venta.motivo_inactivacion}"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Detalles de Productos -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-book"></i> Libros Vendidos</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Libro</th>
                                                <th class="text-center">Cantidad</th>
                                                <th class="text-end">Precio Unit.</th>
                                                <th class="text-end">Subtotal</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="detalle : ${venta.detallesVenta}">
                                                <td th:text="${detalle.libro?.titulo}"></td>
                                                <td class="text-center" th:text="${detalle.cantidad}"></td>
                                                <td class="text-end" th:text="${'$' + #numbers.formatDecimal(detalle.precio_unitario, 1, 'COMMA', 2, 'POINT')}"></td>
                                                <td class="text-end" th:text="${'$' + #numbers.formatDecimal(detalle.subtotal_item, 1, 'COMMA', 2, 'POINT')}"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen Financiero -->
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-calculator"></i> Resumen Financiero</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 offset-md-6">
                                        <table class="table table-sm">
                                            <tr>
                                                <td><strong>Subtotal:</strong></td>
                                                <td class="text-end" th:text="${'$' + #numbers.formatDecimal(venta.subtotal, 1, 'COMMA', 2, 'POINT')}"></td>
                                            </tr>
                                            <tr th:if="${venta.descuento_aplicado != null && venta.descuento_aplicado > 0}">
                                                <td><strong>Descuento:</strong></td>
                                                <td class="text-end text-danger" th:text="${'- $' + #numbers.formatDecimal(venta.descuento_aplicado, 1, 'COMMA', 2, 'POINT')}"></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Impuestos (13%):</strong></td>
                                                <td class="text-end" th:text="${'$' + #numbers.formatDecimal(venta.impuestos, 1, 'COMMA', 2, 'POINT')}"></td>
                                            </tr>
                                            <tr class="table-primary">
                                                <td><strong>TOTAL:</strong></td>
                                                <td class="text-end fw-bold" th:text="${'$' + #numbers.formatDecimal(venta.total, 1, 'COMMA', 2, 'POINT')}"></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
