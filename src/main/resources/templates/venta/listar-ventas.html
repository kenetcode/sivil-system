<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout ('Ventas - Sistema SIVIL', ~{::content})}">
<head>
    <title>Ventas - Sistema SIVIL</title>
</head>
<body>
<div th:fragment="content">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="bi bi-receipt"></i> Gestión de Ventas</h2>
                <p class="text-muted">Listado completo de todas las ventas del sistema</p>
            </div>
            <a th:href="@{/ventas/crear}" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Nueva Venta
            </a>
        </div>
    </div>

    <!-- Mensaje de éxito -->
    <div th:if="${ok}" class="alert alert-success" th:text="${ok}"></div>

    <!-- Mensaje de error -->
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <!-- Tarjetas de estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Ventas</h5>
                    <p class="card-text display-6" th:text="${totalVentas}">0</p>
                </div>
            </div>
        </div>
        <!-- Se eliminaron las tarjetas de Ventas Activas, Ventas Hoy y Promedio por Venta -->
        <!-- Para mantener el espacio visual, podrías dejar los otros 3 col-md-3 vacíos si lo deseas -->
        <div class="col-md-9"></div>
    </div>

    <!-- Tabla de ventas -->
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
            <tr>
                <th>N° Factura</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Vendedor</th>
                <th class="text-end">Subtotal</th>
                <th class="text-end">Impuestos</th>
                <th class="text-end">Total</th>
                <th>Método Pago</th>
                <th>Estado</th>
                <th class="text-center">Acciones</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="venta : ${ventas}">
                <td th:text="${venta.numero_factura}">FAC-001</td>
                <td th:text="${venta.fecha_venta != null} ? ${#temporals.format(venta.fecha_venta, 'dd/MM/yyyy HH:mm')} : '-'">01/01/2023</td>
                <td th:text="${venta.nombre_cliente}">Cliente Ejemplo</td>
                <td th:text="${venta.vendedor != null ? venta.vendedor.nombre_completo : 'N/A'}">Vendedor</td>
                <td class="text-end" th:text="${'$' + #numbers.formatDecimal(venta.subtotal, 1, 'COMMA', 2, 'POINT')}">$0.00</td>
                <td class="text-end" th:text="${'$' + #numbers.formatDecimal(venta.impuestos, 1, 'COMMA', 2, 'POINT')}">$0.00</td>
                <td class="text-end fw-bold" th:text="${'$' + #numbers.formatDecimal(venta.total, 1, 'COMMA', 2, 'POINT')}">$0.00</td>
                <td>
                    <span class="badge bg-info" th:if="${venta.tipo_pago.name() == 'efectivo'}">Efectivo</span>
                    <span class="badge bg-primary" th:if="${venta.tipo_pago.name() == 'tarjeta'}">Tarjeta</span>
                </td>
                <td>
                    <span class="badge bg-success" th:if="${venta.estado.name() == 'activa'}">Activa</span>
                    <span class="badge bg-secondary" th:if="${venta.estado.name() == 'inactiva'}">Inactiva</span>
                    <span class="badge bg-primary" th:if="${venta.estado.name() == 'finalizada'}">Finalizada</span>
                </td>
                <td class="text-center">
                    <!-- Botón Modificar (solo para ventas no inactivas) -->
                    <a th:if="${venta.estado.name() != 'inactiva'}"
                       th:href="@{|/ventas/${venta.id_venta}/modificar|}" 
                       class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-pencil"></i> Modificar
                    </a>

                    <!-- Botón Inactivar (solo para ventas activas y finalizadas) -->
                    <a th:if="${venta.estado.name() != 'inactiva'}"
                       th:href="@{|/ventas/inactivar/${venta.numero_factura}|}"
                       class="btn btn-sm btn-outline-danger" title="Inactivar venta">
                        <i class="bi bi-slash-circle"></i> Inactivar
                    </a>
                    
                    <!-- Botón Reactivar (solo para ventas inactivas) -->
                    <a th:if="${venta.estado.name() == 'inactiva'}"
                       th:href="@{|/ventas/reactivar/${venta.numero_factura}|}"
                       class="btn btn-sm btn-outline-success" title="Reactivar venta">
                        <i class="bi bi-arrow-clockwise"></i> Reactivar
                    </a>
                    
                    <!-- Mostrar motivo de inactivación si está inactiva -->
                    <button th:if="${venta.estado.name() == 'inactiva' && venta.motivo_inactivacion != null}"
                            type="button" class="btn btn-sm btn-outline-secondary" 
                            th:attr="data-motivo=${venta.motivo_inactivacion}"
                            onclick="alert('Motivo de inactivación:\n\n' + this.getAttribute('data-motivo'))"
                            title="Ver motivo de inactivación">
                        <i class="bi bi-info-circle"></i> Motivo
                    </button>

                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(ventas)}">
                <td colspan="10" class="text-center text-muted">No hay ventas registradas</td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
</body>
</html>
