<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout (~{::title}, ~{::content})}">
<head>
    <title>Carrito - Sistema SIVIL</title>
</head>
<body>
<div th:fragment="content">

    <!-- Encabezado -->
    <div class="d-flex align-items-center gap-2 mb-3">
        <i class="bi bi-cart4 fs-3 text-primary"></i>
        <div>
            <h1 class="h4 mb-0">Carrito</h1>
            <small class="text-muted">Administre sus productos antes del pago</small>
        </div>
    </div>

    <!-- Alertas -->
    <div id="msg" role="status" aria-live="polite"></div>

    <!-- Agregar rápido -->
    <div class="card shadow-sm mb-3">
        <div class="card-header bg-white">
            <i class="bi bi-plus-circle me-1"></i> Agregar al carrito (rápido)
        </div>
        <div class="card-body">
            <form class="row g-3">
                <div class="col-12 col-md-2">
                    <label for="libroId" class="form-label">Libro ID</label>
                    <input id="libroId" type="number" class="form-control" placeholder="ID"/>
                </div>
                <div class="col-12 col-md-4">
                    <label for="titulo" class="form-label">Título</label>
                    <input id="titulo" type="text" class="form-control" placeholder="Título" value="Libro demo"/>
                </div>
                <div class="col-6 col-md-2">
                    <label for="precio" class="form-label">Precio</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input id="precio" type="number" step="0.01" class="form-control" placeholder="0.00" value="25.50"/>
                    </div>
                </div>
                <div class="col-6 col-md-2">
                    <label for="cantidad" class="form-label">Cantidad</label>
                    <input id="cantidad" type="number" min="1" class="form-control" placeholder="1" value="1"/>
                </div>
                <div class="col-12 col-md-2 d-flex align-items-end">
                    <button id="btnAdd" class="btn btn-success w-100" type="button">
                        <i class="bi bi-cart-plus"></i> Agregar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla del carrito -->
    <div class="card shadow-sm mb-3">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0" id="tbl">
                <thead class="table-dark">
                <tr>
                    <th>Libro ID</th>
                    <th>Título</th>
                    <th class="text-end">Precio</th>
                    <th class="text-end">Cantidad</th>
                    <th class="text-end">Subtotal</th>
                    <th class="text-center" style="width:110px">Acciones</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Resumen -->
    <div class="row g-3 justify-content-end">
        <div class="col-12 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <i class="bi bi-receipt me-1"></i> Resumen
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Subtotal</span>
                        <strong>$ <span id="sSubtotal">0.00</span></strong>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Impuestos (13%)</span>
                        <strong>$ <span id="sImpuestos">0.00</span></strong>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between fs-5">
                        <span>Total</span>
                        <strong>$ <span id="sTotal">0.00</span></strong>
                    </div>
                </div>
                <div class="card-footer bg-white d-flex justify-content-end gap-2">
                    <button id="btnClear" class="btn btn-outline-danger">
                        <i class="bi bi-trash"></i> Vaciar carrito
                    </button>
                    <a class="btn btn-primary" th:href="@{/compras/checkout}">
                        <i class="bi bi-credit-card"></i> Ir a checkout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- CSRF (si usas Spring Security) -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <script th:inline="javascript">
        const CTX = /*[[@{/}]]*/ "/";
    </script>
    <script>
        const $ = (s) => document.querySelector(s);
        const tbody = $("#tbl tbody");
        const msg = $("#msg");

        // CSRF
        const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content;
        const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;
        function withCsrf(headers = {}) {
          if (CSRF_TOKEN && CSRF_HEADER) headers[CSRF_HEADER] = CSRF_TOKEN;
          return headers;
        }

        const api = {
          items:   () => fetch(CTX + "api/cart/items").then(r => r.json()),
          summary: () => fetch(CTX + "api/cart/summary").then(r => r.json()),
          add:     (body) => fetch(CTX + "api/cart/add", {
                      method:"POST",
                      headers: withCsrf({"Content-Type":"application/json"}),
                      body: JSON.stringify(body)
                    }),
          remove:  (id) => fetch(CTX + "api/cart/remove/" + encodeURIComponent(id), {
                      method:"DELETE",
                      headers: withCsrf()
                    }),
          clear:   () => fetch(CTX + "api/cart/clear", {
                      method:"DELETE",
                      headers: withCsrf()
                    })
        };

        const money = n => (Number(n)||0).toFixed(2);

        function toastOK(text){
          msg.innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-1"></i>${text}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>`;
        }
        function toastWarn(text){
          msg.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-1"></i>${text}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>`;
        }

        async function render() {
          try{
            const [items, summary] = await Promise.all([api.items(), api.summary()]);
            tbody.innerHTML = "";
            items.forEach(it => {
              const tr = document.createElement("tr");
              const subtotal = (Number(it.precioUnitario) * Number(it.cantidad));
              tr.innerHTML = `
                <td>${it.libroId}</td>
                <td>${it.titulo ?? ""}</td>
                <td class="text-end">${money(it.precioUnitario)}</td>
                <td class="text-end">${it.cantidad}</td>
                <td class="text-end">${money(subtotal)}</td>
                <td class="text-center">
                  <button class="btn btn-sm btn-outline-danger" type="button" data-id="${it.libroId}">
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                </td>
              `;
              tbody.appendChild(tr);
            });

            $("#sSubtotal").textContent = money(summary?.subtotal);
            $("#sImpuestos").textContent = money(summary?.impuestos);
            $("#sTotal").textContent = money(summary?.total);

            tbody.querySelectorAll("button[data-id]").forEach(btn=>{
              btn.addEventListener("click", async ()=>{
                try { await api.remove(btn.getAttribute("data-id")); await render(); toastOK("Ítem eliminado"); }
                catch{ toastWarn("No se pudo eliminar"); }
              });
            });
          }catch{
            toastWarn("No se pudo cargar el carrito");
          }
        }

        async function addItem() {
          const body = {
            libroId: parseInt($("#libroId").value, 10),
            titulo: $("#titulo").value,
            precioUnitario: parseFloat($("#precio").value),
            cantidad: parseInt($("#cantidad").value, 10)
          };
          if (!body.libroId || !body.cantidad || body.cantidad < 1) {
            toastWarn("Completa ID y cantidad válida");
            return;
          }
          const res = await api.add(body);
          if (!res.ok) throw new Error();
          await render();
          toastOK("Producto agregado");
        }

        $("#btnAdd").addEventListener("click", async ()=>{ try{ await addItem(); }catch{ toastWarn("No se pudo agregar"); }});
        $("#btnClear").addEventListener("click", async ()=>{ try{ await api.clear(); await render(); toastOK("Carrito vacío"); }catch{ toastWarn("No se pudo vaciar"); }});

        render();
    </script>
</div>
</body>
</html>
