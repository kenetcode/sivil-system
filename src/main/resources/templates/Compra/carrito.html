<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Carrito</title>

    <!-- CSRF (si usas Spring Security; no estorba si no lo usas) -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <style>
        body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:980px;margin:24px auto;padding:0 16px}
        h1{margin:0 0 12px}
        table{width:100%;border-collapse:collapse;margin-top:12px}
        th,td{border:1px solid #ddd;padding:8px;text-align:left}
        th{background:#f5f5f5}
        .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;align-items:end}
        label{font-size:.9rem;color:#555}
        input,select,button,a.btn{padding:8px}
        .right{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:12px}
        .summary{margin-top:12px;padding:12px;border:1px solid #ddd;background:#fafafa}
        .ok{color:#0a7d2c}
        .warn{color:#b33}
        a.btn{display:inline-block;background:#0d6efd;color:#fff;text-decoration:none;border-radius:6px}
        a.btn:hover{filter:brightness(0.95)}
        button.secondary{background:#6c757d;color:#fff;border:none;border-radius:6px}
        button.danger{background:#dc3545;color:#fff;border:none;border-radius:6px}
    </style>
</head>
<body>
<h1>Carrito</h1>

<!-- Fila para agregar rápido -->
<div class="row">
    <div>
        <label for="libroId">Libro ID</label>
        <input id="libroId" type="number" placeholder="Libro ID" />
    </div>
    <div>
        <label for="titulo">Título</label>
        <input id="titulo" type="text" placeholder="Título" value="Libro demo" />
    </div>
    <div>
        <label for="precio">Precio</label>
        <input id="precio" type="number" step="0.01" placeholder="Precio" value="25.50" />
    </div>
    <div>
        <label for="cantidad">Cantidad</label>
        <input id="cantidad" type="number" min="1" placeholder="Cantidad" value="1" />
    </div>
    <button id="btnAdd" class="secondary" type="button">Agregar al carrito</button>
</div>

<table id="tbl">
    <thead>
    <tr>
        <th>Libro ID</th>
        <th>Título</th>
        <th>Precio</th>
        <th>Cantidad</th>
        <th>Subtotal</th>
        <th></th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="summary" id="summaryBox">
    <strong>Resumen:</strong>
    <div>Subtotal: <span id="sSubtotal">0.00</span></div>
    <div>Impuestos (13%): <span id="sImpuestos">0.00</span></div>
    <div>Total: <span id="sTotal">0.00</span></div>
</div>

<div class="right">
    <button id="btnClear" class="danger" type="button">Vaciar carrito</button>
    <!-- A /compras/checkout porque tu controller tiene @RequestMapping("/compras") -->
    <a class="btn" th:href="@{/compras/checkout}" href="/compras/checkout">Ir a checkout</a>
</div>

<div id="msg" role="status" aria-live="polite"></div>

<!-- Context path para fetch (Thymeleaf lo resuelve; si es estático queda "/") -->
<script th:inline="javascript">
    const CTX = /*[[@{/}]]*/ "/";
</script>
<script>
    const $ = (s) => document.querySelector(s);
    const tbody = $("#tbl tbody");
    const msg = $("#msg");

    // CSRF (si aplica)
    const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content;
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;

    function withCsrf(headers = {}) {
      if (CSRF_TOKEN && CSRF_HEADER) headers[CSRF_HEADER] = CSRF_TOKEN;
      return headers;
    }

    const api = {
      items:   () => fetch(CTX + "api/cart/items").then(r => r.json()),
      summary: () => fetch(CTX + "api/cart/summary").then(r => r.json()),
      add:     (body) => fetch(CTX + "api/cart/add", {
                  method:"POST",
                  headers: withCsrf({"Content-Type":"application/json"}),
                  body: JSON.stringify(body)
                }),
      remove:  (id) => fetch(CTX + "api/cart/remove/" + encodeURIComponent(id), {
                  method:"DELETE",
                  headers: withCsrf()
                }),
      clear:   () => fetch(CTX + "api/cart/clear", {
                  method:"DELETE",
                  headers: withCsrf()
                })
    };

    function money(n){ return (Number(n)||0).toFixed(2); }

    async function render() {
      msg.textContent = "";
      const [items, summary] = await Promise.all([api.items(), api.summary()]);

      // tabla
      tbody.innerHTML = "";
      items.forEach(it => {
        const tr = document.createElement("tr");
        const subtotal = (Number(it.precioUnitario) * Number(it.cantidad));
        tr.innerHTML = `
          <td>${it.libroId}</td>
          <td>${it.titulo ?? ""}</td>
          <td>${money(it.precioUnitario)}</td>
          <td>${it.cantidad}</td>
          <td>${money(subtotal)}</td>
          <td><button class="danger" type="button" data-id="${it.libroId}">Eliminar</button></td>
        `;
        tbody.appendChild(tr);
      });

      // resumen
      $("#sSubtotal").textContent = money(summary?.subtotal);
      $("#sImpuestos").textContent = money(summary?.impuestos);
      $("#sTotal").textContent = money(summary?.total);

      // listeners eliminar
      tbody.querySelectorAll("button[data-id]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          try { await api.remove(btn.getAttribute("data-id")); await render(); }
          catch(e){ msg.innerHTML = `<p class="warn">No se pudo eliminar</p>`; }
        });
      });
    }

    async function addItem() {
      const body = {
        libroId: parseInt($("#libroId").value, 10),
        titulo: $("#titulo").value,
        precioUnitario: parseFloat($("#precio").value),
        cantidad: parseInt($("#cantidad").value, 10)
      };
      if (!body.libroId || !body.cantidad || body.cantidad < 1) {
        msg.innerHTML = '<p class="warn">Completa ID y Cantidad válida</p>';
        return;
      }
      const res = await api.add(body);
      if (!res.ok) throw new Error("No se pudo agregar");
      await render();
      msg.innerHTML = '<p class="ok">Agregado</p>';
    }

    $("#btnAdd").addEventListener("click", async ()=>{
      try { await addItem(); } catch(e){ msg.innerHTML = `<p class="warn">${e.message}</p>`; }
    });
    $("#btnClear").addEventListener("click", async ()=>{
      try { await api.clear(); await render(); } catch(e){ msg.innerHTML = `<p class="warn">No se pudo vaciar</p>`; }
    });

    render();
</script>
</body>
</html>
