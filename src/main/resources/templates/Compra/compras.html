<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout (~{::title}, ~{::content})}">
<head>
    <title>Compras - Sistema SIVIL</title>
</head>
<body>
<div th:fragment="content">

    <!-- Encabezado -->
    <div class="d-flex align-items-center gap-2 mb-3">
        <i class="bi bi-bag-check fs-3 text-primary"></i>
        <div>
            <h1 class="h4 mb-0">Compras (resumen)</h1>
            <small class="text-muted">Listado de compras realizadas en el sistema</small>
        </div>
    </div>

    <!-- Alertas -->
    <div id="msg" role="status" aria-live="polite"></div>

    <!-- Tabla -->
    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle mb-0" id="tbl">
                <thead class="table-dark">
                <tr>
                    <th>Orden</th>
                    <th>Comprador</th>
                    <th class="text-end">Subtotal</th>
                    <th class="text-end">Impuestos</th>
                    <th class="text-end">Total</th>
                    <th>Estado</th>
                    <th>Fecha</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script th:inline="javascript">
        const CTX = /*[[@{/}]]*/ "/";
    </script>
    <script>
        const $ = (s) => document.querySelector(s);
        const tbody = $("#tbl tbody");
        const msg = $("#msg");

        const money = (n) => (Number(n) || 0).toFixed(2);

        function toast(type, text){
          const icon  = type === 'ok' ? 'check-circle' : (type === 'warn' ? 'exclamation-triangle' : 'info-circle');
          const klass = type === 'ok' ? 'success'       : (type === 'warn' ? 'danger'                : 'info');
          msg.innerHTML = `<div class="alert alert-${klass} alert-dismissible fade show" role="alert">
            <i class="bi bi-${icon} me-1"></i>${text}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>`;
        }

        function estadoBadge(estadoRaw){
          const e = (estadoRaw || '').toString().trim().toLowerCase();
          if (e === 'pagado' || e === 'completado') return `<span class="badge bg-success">Pagado</span>`;
          if (e === 'pendiente')                     return `<span class="badge bg-warning text-dark">Pendiente</span>`;
          if (e === 'cancelado' || e === 'anulado')  return `<span class="badge bg-secondary">Cancelado</span>`;
          return `<span class="badge bg-light text-dark">${estadoRaw ?? '-'}</span>`;
        }

        function fmtFecha(s){
          try{
            if (!s) return '-';
            const d = new Date(s);
            if (isNaN(d)) return s;
            return d.toLocaleString();
          }catch{ return s || '-'; }
        }

        async function cargar(){
          try{
            const res = await fetch(CTX + "api/compra/listar");
            if (!res.ok) throw new Error("No se pudo cargar la lista de compras");
            const data = await res.json();

            tbody.innerHTML = "";
            if (!data?.length){
              tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">
                <i class="bi bi-inbox me-1"></i> No hay compras registradas.
              </td></tr>`;
              return;
            }

            data.forEach(c=>{
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${c.numeroOrden}</td>
                <td>${c.nombreComprador ?? '-'}</td>
                <td class="text-end">${money(c.subtotal)}</td>
                <td class="text-end">${money(c.impuestos)}</td>
                <td class="text-end"><strong>${money(c.total)}</strong></td>
                <td>${estadoBadge(c.estado)}</td>
                <td>${fmtFecha(c.fecha)}</td>
              `;
              tbody.appendChild(tr);
            });
          }catch(e){
            toast('warn', e.message || 'Error desconocido');
          }
        }

        cargar();
    </script>
</div>
</body>
</html>
