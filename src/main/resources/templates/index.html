<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout/base :: layout (~{::title}, ~{::content})}">
<head>
    <title>Inicio - Sistema SIVIL</title>
</head>
<body>
    <div th:fragment="content">
        <!-- Header de la página -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="bi bi-book"></i> Lista de Libros - Sistema SIVIL</h2>
                <p class="text-muted">Vista de ejemplo mostrando el catálogo de libros desde la API</p>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="loading" class="text-center mb-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando libros...</span>
            </div>
        </div>

        <!-- Tabla de libros -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Catálogo de Libros</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Código</th>
                                <th>Título</th>
                                <th>Autor</th>
                                <th>Año</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Categoría</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tablaLibros">
                            <!-- Los datos se cargan dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Mensaje cuando no hay datos -->
                <div id="noData" class="text-center py-4 d-none">
                    <i class="bi bi-inbox display-4 text-muted"></i>
                    <p class="text-muted mt-2">No se pudieron cargar los libros</p>
                </div>

                <!-- Mensaje de error -->
                <div id="errorMessage" class="alert alert-danger d-none" role="alert">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Error:</strong> <span id="errorText">No se pudo conectar con la API</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts específicos para esta vista -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            cargarLibrosEjemplo();
        });

        async function cargarLibrosEjemplo() {
            try {
                // Mostrar loading
                document.getElementById('loading').classList.remove('d-none');
                document.getElementById('errorMessage').classList.add('d-none');
                
                const response = await fetch('/api/libros');
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const libros = await response.json();
                mostrarLibrosEnTabla(libros);
                
            } catch (error) {
                console.error('Error cargando libros:', error);
                document.getElementById('errorText').textContent = `Error cargando libros: ${error.message}`;
                document.getElementById('errorMessage').classList.remove('d-none');
                document.getElementById('noData').classList.remove('d-none');
            } finally {
                // Ocultar loading
                document.getElementById('loading').classList.add('d-none');
            }
        }

        function mostrarLibrosEnTabla(libros) {
            const tbody = document.getElementById('tablaLibros');
            const noDataDiv = document.getElementById('noData');
            
            if (!libros || libros.length === 0) {
                tbody.innerHTML = '';
                noDataDiv.classList.remove('d-none');
                return;
            }
            
            noDataDiv.classList.add('d-none');
            
            tbody.innerHTML = libros.map(libro => `
                <tr>
                    <td>${libro.id_libro || libro.idLibro || '-'}</td>
                    <td><code>${libro.codigo_libro || libro.codigoLibro || '-'}</code></td>
                    <td><strong>${libro.titulo || '-'}</strong></td>
                    <td>${libro.autor || '-'}</td>
                    <td>${libro.anio_publicacion || libro.anioPublicacion || '-'}</td>
                    <td>${libro.precio ? formatPrecio(libro.precio) : '-'}</td>
                    <td>
                        <span class="badge ${(libro.cantidad_stock || libro.cantidadStock || 0) > 0 ? 'bg-success' : 'bg-danger'}">
                            ${libro.cantidad_stock || libro.cantidadStock || 0}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-info">${libro.categoria || '-'}</span>
                    </td>
                    <td>${formatEstado(libro.estado || 'activo')}</td>
                </tr>
            `).join('');
        }

        function formatPrecio(precio) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(precio);
        }

        function formatEstado(estado) {
            const estados = {
                'activo': { text: 'Activo', class: 'bg-success' },
                'inactivo': { text: 'Inactivo', class: 'bg-danger' }
            };
            
            const config = estados[estado] || { text: estado, class: 'bg-secondary' };
            return `<span class="badge ${config.class}">${config.text}</span>`;
        }
    </script>
</body>
</html>